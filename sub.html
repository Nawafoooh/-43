<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة حصص الانتظار المدرسية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-inactive {
            color: #4a5568;
        }
        .tab-inactive:hover {
            background-color: #f7fafc;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        .priority-1 { background-color: #dcfce7; border-right: 4px solid #16a34a; }
        .priority-2 { background-color: #fef9c3; border-right: 4px solid #ca8a04; }
        .priority-3 { background-color: #fee2e2; border-right: 4px solid #dc2626; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">نظام إدارة حصص الانتظار</h1>
                        <p class="text-gray-600">نظام ذكي لاختيار معلمي الانتظار حسب الأولويات</p>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="saveAllData()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        حفظ البيانات
                    </button>
                    <button onclick="clearAllData()" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        مسح الكل
                    </button>
                    <button onclick="importDefaultSchedule()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        استيراد الجدول الافتراضي
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="hidden mb-4 p-4 rounded-lg notification"></div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-lg mb-6">
            <div class="flex flex-col md:flex-row border-b">
                <button onclick="switchTab('teachers')" id="tab-teachers" class="flex-1 flex items-center justify-center gap-2 px-6 py-4 font-semibold transition tab-active">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    المعلمين
                </button>
                <button onclick="switchTab('schedule')" id="tab-schedule" class="flex-1 flex items-center justify-center gap-2 px-6 py-4 font-semibold transition tab-inactive">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    الجدول المدرسي
                </button>
                <button onclick="switchTab('substitution')" id="tab-substitution" class="flex-1 flex items-center justify-center gap-2 px-6 py-4 font-semibold transition tab-inactive">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    نظام الانتظار الذكي
                </button>
                <button onclick="switchTab('absences')" id="tab-absences" class="flex-1 flex items-center justify-center gap-2 px-6 py-4 font-semibold transition tab-inactive">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    حصص الانتظار
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <!-- Teachers Tab -->
            <div id="content-teachers" class="tab-content">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">قائمة المعلمين وأولويات الانتظار</h2>
                    <button onclick="addTeacher()" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition w-full md:w-auto justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        إضافة معلم
                    </button>
                </div>
                <div id="teachers-list" class="grid gap-4"></div>
            </div>

            <!-- Schedule Tab -->
            <div id="content-schedule" class="tab-content hidden">
                <!-- أداة استيراد الجدول -->
                <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="text-lg font-bold text-blue-800 mb-2">استيراد الجدول المدرسي</h3>
                    <p class="text-blue-600 mb-3">الصق الجدول الكامل من منصة مدرستي وسيتم معالجته تلقائياً</p>
                    <textarea id="schedule-paste-area" rows="10" class="w-full p-3 border border-blue-300 rounded-lg" placeholder="الصق الجدول الكامل هنا..."></textarea>
                    <div class="flex gap-2 mt-2">
                        <button onclick="processPastedSchedule()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                            معالجة الجدول تلقائياً
                        </button>
                        <button onclick="addBulkEntry()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                            إدخال جماعي
                        </button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">الجدول المدرسي</h2>
                    <div class="flex gap-2">
                        <button onclick="addScheduleEntry()" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            إضافة حصة
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <div id="schedule-list"></div>
                </div>
            </div>

            <!-- Substitution Tab -->
            <div id="content-substitution" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- نظام الانتظار الذكي -->
                    <div class="bg-gradient-to-br from-green-50 to-blue-50 p-6 rounded-lg border border-green-200">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">نظام الانتظار الذكي</h2>
                        
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h3 class="font-bold text-lg text-green-700 mb-2">تعيين انتظار تلقائي</h3>
                                <p class="text-gray-600 mb-3">سيقوم النظام باختيار أفضل معلم للانتظار حسب الشروط المحددة</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">اليوم</label>
                                        <select id="substitution-day" class="w-full p-2 border border-gray-300 rounded-lg">
                                            <option value="الأحد">الأحد</option>
                                            <option value="الاثنين">الاثنين</option>
                                            <option value="الثلاثاء">الثلاثاء</option>
                                            <option value="الأربعاء">الأربعاء</option>
                                            <option value="الخميس">الخميس</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">الحصة</label>
                                        <select id="substitution-period" class="w-full p-2 border border-gray-300 rounded-lg">
                                            <option value="1">الحصة 1</option>
                                            <option value="2">الحصة 2</option>
                                            <option value="3">الحصة 3</option>
                                            <option value="4">الحصة 4</option>
                                            <option value="5">الحصة 5</option>
                                            <option value="6">الحصة 6</option>
                                            <option value="7">الحصة 7</option>
                                        </select>
                                    </div>
                                </div>
                                <button onclick="findBestSubstitute()" class="w-full mt-4 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                                    البحث عن أفضل معلم للانتظار
                                </button>
                            </div>

                            <div class="bg-white p-4 rounded-lg shadow">
                                <h3 class="font-bold text-lg text-blue-700 mb-2">تقرير أولويات المعلمين</h3>
                                <button onclick="generatePriorityReport()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                                    توليد تقرير الأولويات
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- نتائج البحث -->
                    <div>
                        <div class="bg-white p-6 rounded-lg shadow border">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">نتائج البحث عن البديل</h3>
                            <div id="substitution-results" class="space-y-3">
                                <p class="text-gray-500 text-center py-8">سيظهر هنا أفضل المعلمين للانتظار حسب الشروط</p>
                            </div>
                        </div>

                        <!-- تقرير الأولويات -->
                        <div id="priority-report" class="mt-6 bg-white p-6 rounded-lg shadow border hidden">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">تقرير أولويات المعلمين</h3>
                            <div id="priority-results"></div>
                        </div>
                    </div>
                </div>

                <!-- شروط النظام -->
                <div class="mt-6 bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                    <h3 class="text-lg font-bold text-yellow-800 mb-3">شروط نظام الانتظار الذكي</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-yellow-700">
                        <div class="flex items-start gap-2">
                            <span class="bg-yellow-200 rounded-full p-1">✓</span>
                            <span>لا يأخذ المعلم أكثر من انتظار واحد في اليوم</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="bg-yellow-200 rounded-full p-1">✓</span>
                            <span>الأولوية لمن لم يأخذ انتظار في الأيام السابقة</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="bg-yellow-200 rounded-full p-1">✓</span>
                            <span>المعلم الذي لديه أكثر من 5 حصص في اليوم لا يدخل الانتظار</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="bg-yellow-200 rounded-full p-1">✓</span>
                            <span>مراعاة عدد حصص الانتظار المطلوبة لكل معلم</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Absences Tab -->
            <div id="content-absences" class="tab-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">إدارة حصص الانتظار</h2>
                    <button onclick="markAbsent()" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition w-full md:w-auto justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        تسجيل غياب معلم
                    </button>
                </div>
                <div id="absences-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <div>
                        <p class="text-gray-600 text-sm">عدد المعلمين</p>
                        <p id="stat-teachers" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="text-gray-600 text-sm">عدد الحصص</p>
                        <p id="stat-schedule" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <div>
                        <p class="text-gray-600 text-sm">حصص الانتظار</p>
                        <p id="stat-absences" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="text-gray-600 text-sm">نظام ذكي</p>
                        <p class="text-3xl font-bold text-gray-800">🔄</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (الكود السابق يبقى كما هو مع إضافة الدوال الجديدة) ...

        // بيانات حصص الانتظار المطلوبة لكل معلم
        const teacherSubstitutionRequirements = {
            "عبدالمجيد الرشيدي": 1,
            "عبدالهادي الشاماني": 3,
            "عبيد العياضي الحربي": 1,
            "علي العلوي الحربي": 0,
            "فهد الشاماني الحربي": 7,
            "فؤاد بن العتيبي": 0,
            "فيصل الصاعدي": 10,
            "محمد بن ذعار العوفي": 2,
            "محمد الزهراني": 4,
            "محمد عياد العوفي": 9,
            "مشعل العمري الحربي": 0,
            "فيصل أبو سلمي": 0,
            "موسى غازي سفر الحربي": 3,
            "موفق مرزوق السحيمي": 9,
            "نافع شعوي المطيري": 3,
            "نميان علي الحربي": 7,
            "ابراهيم عايض الجابري": 10,
            "ابراهيم عياد العلوي": 5,
            "أحمد إبراهيم التركي": 8,
            "أحمد حامد الحربي": 0,
            "اسامه منور العوفي": 3,
            "بدر عبدالعزيز السحيمي": 11,
            "حبيب علي العمري الحربي": 7,
            "حمزة صدقة اسلام": 0,
            "ساير فيصل المطيري": 0,
            "سعد طالع الحربي": 10,
            "سلطان عويض السحيمي": 8,
            "سلمان صالح الحارثي": 11,
            "سيف عبدالمنعم العارضي": 3,
            "عبدالعزيز غلاب المخلفي": 0,
            "عبدالعزيز مفلح الرويثي": 9,
            "عبدالله بن القرني": 3,
            "عبدالله بن مطر العمري": 8,
            "عبدالله حمود الحربي": 0,
            "عبدالله صلاح الرحيلى": 0,
            "أحمد مطر الرشيدي": 3,
            "نواف منصور الصبحي": 3,
            "موسى مسعود الحيسوني": 3
        };

        // دالة البحث عن أفضل بديل حسب الشروط
        function findBestSubstitute() {
            const day = document.getElementById('substitution-day').value;
            const period = document.getElementById('substitution-period').value;
            
            const absentTeacherName = prompt('أدخل اسم المعلم الغائب:');
            if (!absentTeacherName) return;

            const availableTeachers = getAvailableTeachers(day, period, absentTeacherName);
            const rankedTeachers = rankTeachersByPriority(availableTeachers, day);

            displaySubstitutionResults(rankedTeachers, day, period, absentTeacherName);
        }

        // الحصول على المعلمين المتاحين
        function getAvailableTeachers(day, period, absentTeacher) {
            const busyTeachers = schedule
                .filter(s => s.day === day && s.period === period)
                .map(s => s.teacherName);

            return teachers.filter(teacher => {
                // الشروط الأساسية
                const isAvailable = !busyTeachers.includes(teacher.name) && 
                                  teacher.name !== absentTeacher;
                
                // لا يكون لديه أكثر من 5 حصص في اليوم
                const dailyLessons = schedule.filter(s => 
                    s.day === day && s.teacherName === teacher.name
                ).length;
                const hasLessThan5Lessons = dailyLessons < 5;

                // لا يكون قد أخذ انتظار في نفس اليوم
                const hasSubstitutionToday = absences.some(a => 
                    a.day === day && a.substitute === teacher.name
                );

                return isAvailable && hasLessThan5Lessons && !hasSubstitutionToday;
            });
        }

        // ترتيب المعلمين حسب الأولوية
        function rankTeachersByPriority(availableTeachers, day) {
            return availableTeachers.map(teacher => {
                const requiredSubstitutions = teacherSubstitutionRequirements[teacher.name] || 0;
                const currentSubstitutions = teacher.substituteCount || 0;
                const remainingSubstitutions = Math.max(0, requiredSubstitutions - currentSubstitutions);
                
                // حساب عدد الأيام بدون انتظار
                const daysWithoutSubstitution = calculateDaysWithoutSubstitution(teacher.name);
                
                // حساب الأولوية
                let priorityScore = 0;
                
                // الأولوية لمن لديه حصص انتظار مطلوبة أكثر
                priorityScore += remainingSubstitutions * 10;
                
                // الأولوية لمن لم يأخذ انتظار في الأيام السابقة
                priorityScore += daysWithoutSubstitution * 5;
                
                // الأولوية لمن لديه حصص أقل في الجدول
                const weeklyLessons = calculateWeeklyLessons(teacher.name);
                priorityScore += (24 - weeklyLessons) * 2;

                return {
                    ...teacher,
                    priorityScore: priorityScore,
                    remainingSubstitutions: remainingSubstitutions,
                    weeklyLessons: weeklyLessons,
                    daysWithoutSubstitution: daysWithoutSubstitution
                };
            }).sort((a, b) => b.priorityScore - a.priorityScore);
        }

        // حساب عدد الأيام بدون انتظار
        function calculateDaysWithoutSubstitution(teacherName) {
            const today = new Date();
            const substitutionDays = absences
                .filter(a => a.substitute === teacherName)
                .map(a => new Date(a.date));
            
            if (substitutionDays.length === 0) return 7; // أسبوع كامل
            
            const lastSubstitution = new Date(Math.max(...substitutionDays));
            const daysDiff = Math.floor((today - lastSubstitution) / (1000 * 60 * 60 * 24));
            
            return Math.min(7, daysDiff);
        }

        // حساب الحصص الأسبوعية
        function calculateWeeklyLessons(teacherName) {
            return schedule.filter(s => s.teacherName === teacherName).length;
        }

        // عرض نتائج البحث عن البديل
        function displaySubstitutionResults(rankedTeachers, day, period, absentTeacher) {
            const resultsDiv = document.getElementById('substitution-results');
            
            if (rankedTeachers.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                        <p class="text-red-700 font-semibold">⚠️ لا يوجد معلمون متاحون للانتظار</p>
                        <p class="text-red-600 text-sm mt-1">جميع المعلمين إما مشغولون أو لديهم أكثر من 5 حصص في اليوم</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-4">
                    <h4 class="font-bold text-green-800">الغائب: ${absentTeacher}</h4>
                    <p class="text-green-600">اليوم: ${day} - الحصة: ${period}</p>
                </div>
            `;

            rankedTeachers.slice(0, 5).forEach((teacher, index) => {
                const priorityClass = index === 0 ? 'priority-1' : 
                                   index === 1 ? 'priority-2' : 'priority-3';
                
                html += `
                    <div class="p-4 rounded-lg ${priorityClass}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg ${index === 0 ? 'text-green-700' : 'text-gray-700'}">
                                    ${index + 1}. ${teacher.name}
                                </h4>
                                <div class="grid grid-cols-2 gap-2 text-sm mt-2">
                                    <div><span class="text-gray-600">الأولوية:</span> <span class="font-semibold">${teacher.priorityScore}</span></div>
                                    <div><span class="text-gray-600">حصص الانتظار المتبقية:</span> <span class="font-semibold">${teacher.remainingSubstitutions}</span></div>
                                    <div><span class="text-gray-600">الحصص الأسبوعية:</span> <span class="font-semibold">${teacher.weeklyLessons}</span></div>
                                    <div><span class="text-gray-600">أيام بدون انتظار:</span> <span class="font-semibold">${teacher.daysWithoutSubstitution}</span></div>
                                </div>
                            </div>
                            ${index === 0 ? `
                                <button onclick="assignSubstitution('${teacher.name}', '${absentTeacher}', '${day}', '${period}')" 
                                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                    تعيين
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // تعيين الانتظار
        function assignSubstitution(substituteName, absentTeacher, day, period) {
            // العثور على الحصة الأصلية
            const originalLesson = schedule.find(s => 
                s.teacherName === absentTeacher && 
                s.day === day && 
                s.period === period
            );

            if (!originalLesson) {
                showNotification('لم يتم العثور على الحصة الأصلية', 'error');
                return;
            }

            // تحديث عدد حصص الانتظار للمعلم البديل
            teachers = teachers.map(t =>
                t.name === substituteName
                    ? { ...t, substituteCount: (t.substituteCount || 0) + 1 }
                    : t
            );

            // تسجيل حصة الانتظار
            absences.push({
                id: Date.now() + Math.random(),
                date: new Date().toLocaleDateString('ar-SA'),
                absentTeacher: absentTeacher,
                substitute: substituteName,
                day: day,
                period: period,
                subject: originalLesson.subject,
                className: originalLesson.className
            });

            renderTeachers();
            renderAbsences();
            updateStats();
            showNotification(`تم تعيين ${substituteName} بديلاً عن ${absentTeacher}`, 'success');
            
            // تحديث النتائج
            document.getElementById('substitution-results').innerHTML = `
                <div class="bg-green-100 p-4 rounded-lg border border-green-300">
                    <p class="text-green-700 font-semibold">✅ تم التعيين بنجاح</p>
                    <p class="text-green-600">المعلم ${substituteName} تم تعيينه للانتظار</p>
                </div>
            `;
        }

        // توليد تقرير الأولويات
        function generatePriorityReport() {
            const reportDiv = document.getElementById('priority-results');
            const priorityReport = document.getElementById('priority-report');
            
            let html = '<div class="space-y-3">';
            
            teachers.forEach(teacher => {
                const required = teacherSubstitutionRequirements[teacher.name] || 0;
                const current = teacher.substituteCount || 0;
                const remaining = Math.max(0, required - current);
                const weeklyLessons = calculateWeeklyLessons(teacher.name);
                
                let status = '';
                let statusColor = '';
                
                if (remaining === 0 && required > 0) {
                    status = 'مكتمل';
                    statusColor = 'text-green-600';
                } else if (remaining > 0) {
                    status = `متبقي ${remaining}`;
                    statusColor = 'text-orange-600';
                } else {
                    status = 'غير مطلوب';
                    statusColor = 'text-gray-500';
                }
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="font-semibold">${teacher.name}</h4>
                            <div class="flex gap-4 text-sm text-gray-600">
                                <span>الحصص الأسبوعية: ${weeklyLessons}</span>
                                <span>حصص الانتظار: ${current}/${required}</span>
                            </div>
                        </div>
                        <span class="${statusColor} font-semibold">${status}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            reportDiv.innerHTML = html;
            priorityReport.classList.remove('hidden');
        }

                // تحديث التبويبات
        function switchTab(tab) {
            const tabs = ['teachers', 'schedule', 'substitution', 'absences'];
            tabs.forEach(t => {
                const tabBtn = document.getElementById(`tab-${t}`);
                const content = document.getElementById(`content-${t}`);
                if (t === tab) {
                    tabBtn.className = 'flex-1 flex items-center justify-center gap-2 px-6 py-4 font-semibold transition tab-active';
                    content.classList.remove('hidden');
                } else {
                    tabBtn.className = 'flex-1 flex items-center justify-center gap-2 px-6 py-4 font-semibold transition tab-inactive';
                    content.classList.add('hidden');
                }
            });
        }

        // إضافة معلم جديد
        function addTeacher() {
            const name = prompt('أدخل اسم المعلم:');
            const subject = prompt('أدخل التخصص:');
            if (name && subject) {
                teachers.push({
                    id: Date.now(),
                    name,
                    subject,
                    substituteCount: 0
                });
                renderTeachers();
                updateStats();
                showNotification('تم إضافة المعلم بنجاح', 'success');
            }
        }

        // حذف معلم
        function deleteTeacher(id) {
            if (confirm('هل أنت متأكد من حذف هذا المعلم؟')) {
                teachers = teachers.filter(t => t.id !== id);
                renderTeachers();
                updateStats();
                showNotification('تم حذف المعلم', 'success');
            }
        }

        // إضافة حصة للجدول
        function addScheduleEntry() {
            const teacherName = prompt('اسم المعلم:');
            const day = prompt('اليوم (الأحد، الاثنين، الثلاثاء، الأربعاء، الخميس):');
            const period = prompt('رقم الحصة (1-7):');
            const subject = prompt('المادة:');
            const className = prompt('الصف:');

            if (teacherName && day && period && subject && className) {
                schedule.push({
                    id: Date.now(),
                    teacherName,
                    day,
                    period,
                    subject,
                    className
                });
                renderSchedule();
                updateStats();
                showNotification('تم إضافة الحصة للجدول', 'success');
            }
        }

        // حذف حصة من الجدول
        function deleteSchedule(id) {
            schedule = schedule.filter(s => s.id !== id);
            renderSchedule();
            updateStats();
            showNotification('تم حذف الحصة', 'success');
        }

        // البحث عن معلم بديل (الطريقة القديمة - تبقى للتوافق)
        function findSubstitute(absentTeacher, day, period) {
            const busyTeachers = schedule
                .filter(s => s.day === day && s.period === period)
                .map(s => s.teacherName);

            const availableTeachers = teachers
                .filter(t => t.name !== absentTeacher && !busyTeachers.includes(t.name))
                .sort((a, b) => a.substituteCount - b.substituteCount);

            return availableTeachers[0] || null;
        }

        // تسجيل غياب معلم (الطريقة القديمة - محسنة)
        function markAbsent() {
            const absentTeacherName = prompt('أدخل اسم المعلم الغائب:');
            if (!absentTeacherName) return;

            const todaySchedule = schedule.filter(s => s.teacherName === absentTeacherName);

            if (todaySchedule.length === 0) {
                showNotification('لا توجد حصص لهذا المعلم في الجدول', 'error');
                return;
            }

            // استخدام النظام الذكي لكل حصة
            todaySchedule.forEach(entry => {
                const availableTeachers = getAvailableTeachers(entry.day, entry.period, absentTeacherName);
                const rankedTeachers = rankTeachersByPriority(availableTeachers, entry.day);
                
                if (rankedTeachers.length > 0) {
                    const bestSubstitute = rankedTeachers[0];
                    assignSubstitution(bestSubstitute.name, absentTeacherName, entry.day, entry.period);
                } else {
                    absences.push({
                        id: Date.now() + Math.random(),
                        date: new Date().toLocaleDateString('ar-SA'),
                        absentTeacher: absentTeacherName,
                        substitute: 'لا يوجد بديل متاح',
                        day: entry.day,
                        period: entry.period,
                        subject: entry.subject,
                        className: entry.className
                    });
                }
            });

            renderAbsences();
            renderTeachers();
            updateStats();
            showNotification(`تم معالجة ${todaySchedule.length} حصة للغياب`, 'success');
        }

        // حذف سجل غياب
        function deleteAbsence(id) {
            const absence = absences.find(a => a.id === id);
            if (absence && absence.substitute !== 'لا يوجد بديل متاح') {
                // تقليل عدد حصص الانتظار للمعلم البديل
                teachers = teachers.map(t =>
                    t.name === absence.substitute && t.substituteCount > 0
                        ? { ...t, substituteCount: t.substituteCount - 1 }
                        : t
                );
            }
            
            absences = absences.filter(a => a.id !== id);
            renderAbsences();
            renderTeachers();
            updateStats();
            showNotification('تم حذف سجل الغياب', 'success');
        }

        // ========== الميزات الجديدة ==========

        // معالجة الجدول المدرسي المنسوخ
        function processPastedSchedule() {
            const pasteArea = document.getElementById('schedule-paste-area');
            const data = pasteArea.value.trim();
            
            if (!data) {
                showNotification('يرجى لصق الجدول أولاً', 'error');
                return;
            }

            const lines = data.split('\n').filter(line => line.trim());
            let scheduleEntries = [];
            let currentClass = '';
            let currentDay = '';
            let currentPeriod = 1;

            lines.forEach(line => {
                line = line.trim();
                
                // اكتشاف الصف
                if (line.includes('الثالث') || line.includes('الثاني') || line.includes('الأول')) {
                    currentClass = extractClassName(line);
                    return;
                }
                
                // اكتشاف اليوم
                const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
                const foundDay = days.find(day => line.includes(day));
                if (foundDay) {
                    currentDay = foundDay;
                    currentPeriod = 1;
                    return;
                }
                
                // اكتشاف الحصة
                if (line.includes('الحصة')) {
                    currentPeriod = extractPeriodNumber(line);
                    return;
                }
                
                // استخراج بيانات الحصة
                const periodData = extractPeriodData(line, currentClass, currentDay, currentPeriod);
                if (periodData) {
                    scheduleEntries.push(periodData);
                    currentPeriod++;
                }
            });

            // إضافة الحصص إلى الجدول
            let addedCount = 0;
            scheduleEntries.forEach(entry => {
                if (isValidScheduleEntry(entry)) {
                    // تجنب التكرار
                    const exists = schedule.some(s => 
                        s.teacherName === entry.teacher && 
                        s.day === entry.day && 
                        s.period === entry.period && 
                        s.className === entry.className
                    );
                    
                    if (!exists) {
                        schedule.push({
                            id: Date.now() + Math.random(),
                            teacherName: entry.teacher,
                            day: entry.day,
                            period: entry.period,
                            subject: entry.subject,
                            className: entry.className
                        });
                        addedCount++;
                    }
                }
            });

            renderSchedule();
            updateStats();
            showNotification(`تمت إضافة ${addedCount} حصة بنجاح`, 'success');
            pasteArea.value = '';
        }

        // استخراج اسم الصف
        function extractClassName(line) {
            const classMatch = line.match(/(الثالث|الثاني|الأول)\s*-\s*[\d١٢٣٤٥٦]/);
            return classMatch ? classMatch[0] : '';
        }

        // استخراج رقم الحصة
        function extractPeriodNumber(line) {
            const periodMatch = line.match(/الحصة\s*(\d+)/);
            return periodMatch ? parseInt(periodMatch[1]) : 1;
        }

        // استخراج بيانات الحصة
        function extractPeriodData(line, className, day, period) {
            if (!line || line.includes('اليوم') || line.includes('الحصة') || !className || !day) {
                return null;
            }

            // استخراج المادة والمعلم
            const subjectMatch = line.match(/^([^:]+)/);
            const teacherMatch = line.match(/المعلم\s*:\s*([^\.]+)/);
            
            if (subjectMatch && teacherMatch) {
                return {
                    subject: subjectMatch[1].trim(),
                    teacher: teacherMatch[1].trim(),
                    className: className,
                    day: day,
                    period: period
                };
            }
            
            return null;
        }

        // التحقق من صحة بيانات الحصة
        function isValidScheduleEntry(entry) {
            return entry.teacher && entry.subject && entry.className && entry.day && entry.period;
        }

        // إدخال جماعي للبيانات
        function addBulkEntry() {
            const bulkData = prompt(`📝 أدخل بيانات الحصص (سطر لكل حصة - مفصولة بفاصلة):
            
الصيغة: المعلم,اليوم,الحصة,المادة,الصف

أمثلة:
محمد أحمد, الأحد, 1, رياضيات, أول/أ
علي سالم, الأحد, 2, علوم, ثاني/ب
فاطمة محمد, الأحد, 3, لغة عربية, ثالث/ج`);

            if (bulkData) {
                const lines = bulkData.split('\n');
                let added = 0;
                
                lines.forEach(line => {
                    const [teacher, day, period, subject, className] = line.split(',').map(item => item.trim());
                    if (teacher && day && period && subject && className) {
                        schedule.push({
                            id: Date.now() + Math.random(),
                            teacherName: teacher,
                            day: day,
                            period: period,
                            subject: subject,
                            className: className
                        });
                        added++;
                    }
                });
                
                renderSchedule();
                updateStats();
                showNotification(`تم إضافة ${added} حصة بنجاح`, 'success');
            }
        }

        // ========== نهاية الميزات الجديدة ==========

        // عرض قائمة المعلمين
        function renderTeachers() {
            const list = document.getElementById('teachers-list');
            if (teachers.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <p class="text-lg">لا توجد معلمين بعد. ابدأ بإضافة معلم!</p>
                    </div>
                `;
            } else {
                list.innerHTML = teachers.map(teacher => {
                    const required = teacherSubstitutionRequirements[teacher.name] || 0;
                    const current = teacher.substituteCount || 0;
                    const remaining = Math.max(0, required - current);
                    const weeklyLessons = calculateWeeklyLessons(teacher.name);
                    
                    let statusBadge = '';
                    if (required > 0) {
                        if (remaining === 0) {
                            statusBadge = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">مكتمل</span>';
                        } else {
                            statusBadge = `<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs">متبقي ${remaining}</span>`;
                        }
                    } else {
                        statusBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">غير مطلوب</span>';
                    }
                    
                    return `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="font-bold text-lg text-gray-800">${teacher.name}</h3>
                                    ${statusBadge}
                                </div>
                                <p class="text-gray-600">التخصص: ${teacher.subject}</p>
                                <div class="flex gap-4 text-sm mt-1">
                                    <p class="text-indigo-600">حصص الانتظار: ${current}/${required}</p>
                                    <p class="text-blue-600">الحصص الأسبوعية: ${weeklyLessons}</p>
                                </div>
                            </div>
                            <button onclick="deleteTeacher(${teacher.id})" class="text-red-600 hover:bg-red-100 p-2 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        // عرض الجدول المدرسي
        function renderSchedule() {
            const list = document.getElementById('schedule-list');
            if (schedule.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg">لا توجد حصص في الجدول. ابدأ باستيراد الجدول الافتراضي!</p>
                    </div>
                `;
            } else {
                list.innerHTML = `
                    <table class="w-full">
                        <thead>
                            <tr class="bg-indigo-600 text-white">
                                <th class="p-3 text-right">اليوم</th>
                                <th class="p-3 text-right">الحصة</th>
                                <th class="p-3 text-right">المعلم</th>
                                <th class="p-3 text-right">المادة</th>
                                <th class="p-3 text-right">الصف</th>
                                <th class="p-3 text-center">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${schedule.map(entry => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-3">${entry.day}</td>
                                    <td class="p-3">${entry.period}</td>
                                    <td class="p-3 font-semibold">${entry.teacherName}</td>
                                    <td class="p-3">${entry.subject}</td>
                                    <td class="p-3">${entry.className}</td>
                                    <td class="p-3 text-center">
                                        <button onclick="deleteSchedule(${entry.id})" class="text-red-600 hover:bg-red-100 p-2 rounded-lg transition">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        // عرض سجلات الغياب
        function renderAbsences() {
            const list = document.getElementById('absences-list');
            if (absences.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <p class="text-lg">لا توجد سجلات غياب حتى الآن</p>
                    </div>
                `;
            } else {
                list.innerHTML = absences.map(absence => `
                    <div class="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border-r-4 ${absence.substitute === 'لا يوجد بديل متاح' ? 'border-red-500' : 'border-orange-500'}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">غائب</span>
                                    <span class="font-bold text-lg">${absence.absentTeacher}</span>
                                    ${absence.substitute !== 'لا يوجد بديل متاح' ? 
                                        `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">بديل: ${absence.substitute}</span>` :
                                        `<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">لا يوجد بديل</span>`
                                    }
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                    <div><span class="text-gray-600">التاريخ:</span> <span class="font-semibold">${absence.date}</span></div>
                                    <div><span class="text-gray-600">اليوم:</span> <span class="font-semibold">${absence.day}</span></div>
                                    <div><span class="text-gray-600">الحصة:</span> <span class="font-semibold">${absence.period}</span></div>
                                    <div><span class="text-gray-600">المادة:</span> <span class="font-semibold">${absence.subject}</span></div>
                                    <div><span class="text-gray-600">الصف:</span> <span class="font-semibold">${absence.className}</span></div>
                                </div>
                            </div>
                            <button onclick="deleteAbsence(${absence.id})" class="text-red-600 hover:bg-red-100 p-2 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // تحديث الإحصائيات
        function updateStats() {
            document.getElementById('stat-teachers').textContent = teachers.length;
            document.getElementById('stat-schedule').textContent = schedule.length;
            document.getElementById('stat-absences').textContent = absences.length;
        }

        // عرض كل المحتوى
        function renderAll() {
            renderTeachers();
            renderSchedule();
            renderAbsences();
            updateStats();
        }

        // تهيئة الصفحة
        window.onload = function() {
            loadData();
        };
    </script>
</body>
</html>
