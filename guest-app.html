<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¶ÙŠÙÙŠ Ø§Ù„Ø°ÙƒÙŠ - ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø²ÙŠÙ„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2563eb; --primary-hover: #1d4ed8; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc; --text: #1e293b;
            --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Tajawal', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: var(--text); line-height: 1.6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: white; padding: 30px; border-radius: 20px; box-shadow: var(--shadow);
            text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px;
            border-radius: 15px; box-shadow: var(--shadow); }
        .tab-btn { flex: 1; padding: 15px; background: transparent; border: none;
            font-family: 'Tajawal', sans-serif; font-size: 1rem; font-weight: 600;
            color: #64748b; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
        .tab-btn:hover { background: var(--bg); color: var(--primary); }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: var(--shadow); }
        .card-header { margin-bottom: 25px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
        .card-header h2 { font-size: 1.5rem; color: var(--text); margin-bottom: 5px; }
        .card-header p { color: #64748b; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px;
            border: 2px solid var(--border); border-radius: 10px; font-family: 'Tajawal', sans-serif;
            font-size: 1rem; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .counter { display: flex; align-items: center; gap: 15px; max-width: 200px; }
        .counter-btn { width: 50px; height: 50px; border: 2px solid var(--primary);
            background: white; color: var(--primary); font-size: 1.5rem; font-weight: bold;
            border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .counter-btn:hover { background: var(--primary); color: white; }
        .counter input { width: 80px; text-align: center; font-size: 1.2rem; font-weight: 600; }
        .radio-group { display: flex; gap: 15px; }
        .radio-option { flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px;
            cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .radio-option:hover { border-color: var(--primary); background: rgba(37, 99, 235, 0.05); }
        .radio-option input[type="radio"] { margin-left: 8px; }
        .file-upload { display: flex; align-items: center; gap: 15px; padding: 20px;
            border: 2px dashed var(--border); border-radius: 10px; background: var(--bg); }
        .upload-btn { padding: 10px 20px; background: var(--primary); color: white; border: none;
            border-radius: 8px; font-family: 'Tajawal', sans-serif; font-weight: 600; cursor: pointer; }
        .upload-btn:hover { background: var(--primary-hover); }
        .file-name { color: #64748b; font-size: 0.9rem; }
        .congestion { padding: 15px; border-radius: 10px; margin-top: 10px; margin-bottom: 15px; display: none; }
        .congestion.show { display: block; }
        .congestion.low { background: #d1fae5; border-right: 4px solid var(--success); color: #065f46; }
        .congestion.medium { background: #fef3c7; border-right: 4px solid var(--warning); color: #92400e; }
        .congestion.high { background: #fee2e2; border-right: 4px solid var(--danger); color: #991b1b; }
        .btn-primary { width: 100%; padding: 15px 30px; border: none; border-radius: 12px;
            font-family: 'Tajawal', sans-serif; font-size: 1.1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s; background: var(--primary); color: white;
            box-shadow: var(--shadow); margin-top: 15px; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .request-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; margin: 20px 0; }
        .request-btn { padding: 20px; border: 2px solid var(--border); background: white;
            border-radius: 12px; cursor: pointer; transition: all 0.3s; display: flex;
            flex-direction: column; align-items: center; gap: 10px; }
        .request-btn:hover { border-color: var(--primary); background: rgba(37, 99, 235, 0.05);
            transform: translateY(-4px); box-shadow: var(--shadow); }
        .request-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
        .request-btn .icon { font-size: 2.5rem; }
        .request-btn span:last-child { font-weight: 600; font-size: 1rem; }
        .request-details { margin-top: 20px; padding: 20px; background: var(--bg);
            border-radius: 12px; display: none; }
        .request-details.show { display: block; }
        .chatbot { margin-top: 30px; padding: 20px; background: var(--bg); border-radius: 15px; }
        .chatbot-header { text-align: center; margin-bottom: 15px; }
        .chatbot-header h3 { font-size: 1.3rem; color: var(--text); }
        .chat-messages { height: 300px; overflow-y: auto; padding: 15px; background: white;
            border-radius: 12px; margin-bottom: 15px; }
        .chat-message { padding: 12px; margin-bottom: 10px; border-radius: 12px; max-width: 80%;
            animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); } }
        .bot-message { background: var(--primary); color: white; margin-left: 0; margin-right: auto; }
        .user-message { background: var(--bg); color: var(--text); margin-right: 0; margin-left: auto; }
        .quick-questions { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .quick-q-btn { padding: 8px 15px; background: white; border: 2px solid var(--border);
            border-radius: 20px; font-family: 'Tajawal', sans-serif; font-size: 0.9rem;
            cursor: pointer; transition: all 0.3s; }
        .quick-q-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; padding: 12px; border: 2px solid var(--border);
            border-radius: 12px; font-family: 'Tajawal', sans-serif; }
        .chat-input-area button { padding: 12px 20px; background: var(--primary); color: white;
            border: none; border-radius: 12px; font-family: 'Tajawal', sans-serif;
            font-weight: 600; cursor: pointer; }
        .chat-input-area button:hover { background: var(--primary-hover); }
        .invoice { padding: 20px; background: var(--bg); border-radius: 12px; margin: 20px 0; }
        .invoice h3 { margin-bottom: 15px; color: var(--text); }
        .invoice-item { display: flex; justify-content: space-between; padding: 10px 0;
            border-bottom: 1px solid var(--border); }
        .invoice-item.total { font-weight: 700; font-size: 1.2rem; color: var(--primary);
            border-bottom: none; margin-top: 10px; }
        .invoice-note { margin-top: 15px; font-size: 0.9rem; color: #64748b; font-style: italic; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(50%);
            background: var(--text); color: white; padding: 15px 30px; border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); z-index: 2000; display: none;
            animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translate(50%, 50px); opacity: 0; }
            to { transform: translate(50%, 0); opacity: 1; } }
        .toast.show { display: block; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .request-buttons { grid-template-columns: repeat(2, 1fr); }
            .card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ Ù…Ø¶ÙŠÙÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø§Ù„Ù†Ø²Ù„Ø§Ø¡</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="arrival">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„</button>
            <button class="tab-btn" data-tab="departure">Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©</button>
            <button class="tab-btn" data-tab="requests">Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>

        <div id="arrivalTab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                    <p>Ø³Ø§Ø¹Ø¯Ù†Ø§ ÙÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ø³ØªÙ‚Ø¨Ø§Ù„Ùƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ</p>
                </div>
                <form id="arrivalForm">
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</label>
                        <input type="text" id="bookingNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù†Ø²ÙŠÙ„</label>
                        <input type="text" id="guestName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                    </div>
                    <div class="form-group">
                        <label>â° ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</label>
                        <select id="arrivalTime" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>
                        </select>
                    </div>
                    <div id="congestionIndicator" class="congestion"></div>
                    <div class="form-group">
                        <label>ğŸš— ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù†Ù‚Ù„</label>
                        <select id="transportType" required>
                            <option value="">Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù†Ù‚Ù„</option>
                            <option value="taxi">ØªØ§ÙƒØ³ÙŠ</option>
                            <option value="private">Ø³ÙŠØ§Ø±Ø© Ø®Ø§ØµØ©</option>
                        </select>
                    </div>
                    <div class="form-group" id="plateNumberGroup" style="display: none;">
                        <label>ğŸ”¢ Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                        <input type="text" id="plateNumber" placeholder="Ù…Ø«Ø§Ù„: Ø£ Ø¨ Ø¬ 1234">
                    </div>
                    <div class="form-group">
                        <label>ğŸ§³ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨</label>
                        <div class="counter">
                            <button type="button" class="counter-btn" data-action="decrease" data-target="luggageCount">-</button>
                            <input type="number" id="luggageCount" value="1" min="0" max="10" readonly>
                            <button type="button" class="counter-btn" data-action="increase" data-target="luggageCount">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</label>
                        <div class="file-upload">
                            <input type="file" id="idUpload" accept="image/*" style="display: none;">
                            <button type="button" class="upload-btn" onclick="document.getElementById('idUpload').click()">ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</button>
                            <span id="fileName" class="file-name">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</span>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ âœˆï¸</button>
                </form>
            </div>
        </div>

        <div id="departureTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸšª Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©</h2>
                    <p>Ù†Ø¸Ù… Ù…ÙˆØ¹Ø¯ Ù…ØºØ§Ø¯Ø±ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
                </div>
                <form id="departureForm">
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</label>
                        <input type="text" id="departureBookingNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²" required>
                    </div>
                    <div class="form-group">
                        <label>â° ÙˆÙ‚Øª Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</label>
                        <select id="departureTime" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª</option>
                        </select>
                    </div>
                    <div id="departureCongestionIndicator" class="congestion"></div>
                    <div class="form-group">
                        <label>ğŸ’¼ Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ØŸ</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="luggageHelp" value="yes">
                                <span>Ù†Ø¹Ù…</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="luggageHelp" value="no" checked>
                                <span>Ù„Ø§</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="departureLuggageGroup" style="display: none;">
                        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨</label>
                        <div class="counter">
                            <button type="button" class="counter-btn" data-action="decrease" data-target="departureLuggageCount">-</button>
                            <input type="number" id="departureLuggageCount" value="1" min="1" max="10" readonly>
                            <button type="button" class="counter-btn" data-action="increase" data-target="departureLuggageCount">+</button>
                        </div>
                    </div>
                    <div class="invoice">
                        <h3>ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                        <div class="invoice-item"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ:</span><span>3 Ù„ÙŠØ§Ù„ÙŠ</span></div>
                        <div class="invoice-item"><span>Ø³Ø¹Ø± Ø§Ù„Ù„ÙŠÙ„Ø©:</span><span>500 Ø±ÙŠØ§Ù„</span></div>
                        <div class="invoice-item total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span>1,500 Ø±ÙŠØ§Ù„</span></div>
                        <p class="invoice-note">* Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø³ØªÙƒÙˆÙ† Ø¹Ù†Ø¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©</p>
                    </div>
                    <button type="submit" class="btn-primary">ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ğŸš€</button>
                </form>
            </div>
        </div>

        <div id="requestsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ›ï¸ Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                    <p>Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ø®Ø¯Ù…ØªÙƒ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</p>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² / Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©</label>
                    <input type="text" id="requestBookingNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² Ø£Ùˆ Ø§Ù„ØºØ±ÙØ©">
                </div>
                <div class="request-buttons">
                    <button class="request-btn" data-request="cleaning">
                        <span class="icon">ğŸ§¹</span>
                        <span>Ø·Ù„Ø¨ ØªÙ†Ø¸ÙŠÙ</span>
                    </button>
                    <button class="request-btn" data-request="supplies">
                        <span class="icon">ğŸ§´</span>
                        <span>Ø·Ù„Ø¨ Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª</span>
                    </button>
                    <button class="request-btn" data-request="maintenance">
                        <span class="icon">ğŸ”§</span>
                        <span>Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø©</span>
                    </button>
                    <button class="request-btn" data-request="food">
                        <span class="icon">ğŸ½ï¸</span>
                        <span>Ø·Ù„Ø¨ Ø·Ø¹Ø§Ù…</span>
                    </button>
                    <button class="request-btn" data-request="other">
                        <span class="icon">ğŸ’¬</span>
                        <span>Ø·Ù„Ø¨ Ø¢Ø®Ø±</span>
                    </button>
                </div>
                <div id="requestDetails" class="request-details">
                    <textarea id="requestNotes" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§..." rows="4" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-family:'Tajawal',sans-serif;"></textarea>
                    <button id="submitRequest" class="btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸ“¤</button>
                </div>
                <div class="chatbot">
                    <div class="chatbot-header">
                        <h3>ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¢Ù„ÙŠ</h3>
                        <p>Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡!</p>
                    </div>
                    <div id="chatMessages" class="chat-messages">
                        <div class="chat-message bot-message">Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
                    </div>
                    <div class="quick-questions">
                        <button class="quick-q-btn" data-question="Ù…Ø§ Ù‡ÙŠ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¥ÙØ·Ø§Ø±ØŸ">ğŸ³ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¥ÙØ·Ø§Ø±</button>
                        <button class="quick-q-btn" data-question="Ø£ÙŠÙ† Ù…ÙˆÙ‚Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø§ØªØŸ">ğŸš— Ù…ÙˆÙ‚Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
                        <button class="quick-q-btn" data-question="ÙƒÙŠÙ Ø£ØªØµÙ„ Ø¨Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ØŸ">ğŸ“ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</button>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...">
                        <button id="sendChatBtn">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDld4NfSWqA5EKYLXo08NpeCewpICYbDLI",
            authDomain: "mudeefy-smart-hotel.firebaseapp.com",
            projectId: "mudeefy-smart-hotel",
            storageBucket: "mudeefy-smart-hotel.firebasestorage.app",
            messagingSenderId: "776841372805",
            appId: "1:776841372805:web:2d248105748b49975175ec"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
            });
        });

        const times = [];
        for (let h = 12; h <= 23; h++) {
            for (let m = 0; m < 60; m += 30) {
                const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                const display = new Date(`2000-01-01T${time}`).toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit', hour12: true});
                times.push({ value: time, display });
            }
        }
        times.forEach(t => {
            ['arrivalTime', 'departureTime'].forEach(id => {
                const opt = document.createElement('option');
                opt.value = t.value;
                opt.textContent = t.display;
                document.getElementById(id).appendChild(opt);
            });
        });

        document.getElementById('transportType').addEventListener('change', e => {
            document.getElementById('plateNumberGroup').style.display = e.target.value === 'private' ? 'block' : 'none';
        });

        async function updateCongestion(time, type) {
            const ind = document.getElementById(type === 'arrival' ? 'congestionIndicator' : 'departureCongestionIndicator');
            if (!time) { ind.classList.remove('show'); return; }
            const today = new Date().toISOString().split('T')[0];
            const col = type === 'arrival' ? 'arrivals' : 'departures';
            const field = type === 'arrival' ? 'arrivalTime' : 'departureTime';
            const q = query(collection(db, col), where('date', '==', today), where(field, '==', time));
            const snap = await getDocs(q);
            const count = snap.size;
            let msg, cls;
            if (count === 0) { msg = 'âœ… ØºÙŠØ± Ù…Ø²Ø¯Ø­Ù… - ÙˆÙ‚Øª Ù…Ù…ØªØ§Ø²'; cls = 'low'; }
            else if (count <= 2) { msg = `âš ï¸ Ø§Ø²Ø¯Ø­Ø§Ù… Ù…ØªÙˆØ³Ø· - ${count} Ø­Ø¬Ø²`; cls = 'medium'; }
            else { msg = `ğŸš¨ Ù…Ø²Ø¯Ø­Ù… - ${count} Ø­Ø¬ÙˆØ²Ø§Øª`; cls = 'high'; }
            ind.textContent = msg;
            ind.className = `congestion show ${cls}`;
        }

        document.getElementById('arrivalTime').addEventListener('change', e => updateCongestion(e.target.value, 'arrival'));
        document.getElementById('departureTime').addEventListener('change', e => updateCongestion(e.target.value, 'departure'));

        document.querySelectorAll('.counter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = document.getElementById(btn.dataset.target);
                let val = parseInt(input.value);
                if (btn.dataset.action === 'increase' && val < parseInt(input.max)) input.value = val + 1;
                if (btn.dataset.action === 'decrease' && val > parseInt(input.min)) input.value = val - 1;
            });
        });

        document.getElementById('idUpload').addEventListener('change', e => {
            document.getElementById('fileName').textContent = e.target.files.length ? e.target.files[0].name : 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù';
        });

        document.getElementById('arrivalForm').addEventListener('submit', async e => {
            e.preventDefault();
            try {
                const booking = document.getElementById('bookingNumber').value;
                const name = document.getElementById('guestName').value;
                const time = document.getElementById('arrivalTime').value;
                const transport = document.getElementById('transportType').value;
                const plate = document.getElementById('plateNumber').value;
                const luggage = parseInt(document.getElementById('luggageCount').value);
                const file = document.getElementById('idUpload').files[0];
                let url = null;
                if (file) {
                    const storageRef = ref(storage, `id-images/${booking}-${Date.now()}`);
                    const snap = await uploadBytes(storageRef, file);
                    url = await getDownloadURL(snap.ref);
                }
                await addDoc(collection(db, 'arrivals'), {
                    bookingNumber: booking, guestName: name, arrivalTime: time, transportType: transport,
                    plateNumber: transport === 'private' ? plate : null, luggageCount: luggage, idImageUrl: url,
                    status: 'Ù‚Ø§Ø¯Ù…', createdAt: Timestamp.now(), date: new Date().toISOString().split('T')[0]
                });
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! âœˆï¸', 'success');
                e.target.reset();
                document.getElementById('fileName').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù';
                document.getElementById('congestionIndicator').classList.remove('show');
            } catch (err) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
            }
        });

        document.querySelectorAll('input[name="luggageHelp"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('departureLuggageGroup').style.display = 
                    document.querySelector('input[name="luggageHelp"]:checked').value === 'yes' ? 'block' : 'none';
            });
        });

        document.getElementById('departureForm').addEventListener('submit', async e => {
            e.preventDefault();
            try {
                const booking = document.getElementById('departureBookingNumber').value;
                const time = document.getElementById('departureTime').value;
                const help = document.querySelector('input[name="luggageHelp"]:checked').value;
                const count = help === 'yes' ? parseInt(document.getElementById('departureLuggageCount').value) : 0;
                await addDoc(collection(db, 'departures'), {
                    bookingNumber: booking, departureTime: time, luggageHelp: help === 'yes', luggageCount: count,
                    status: 'Ù…Ø¬Ø¯ÙˆÙ„', createdAt: Timestamp.now(), date: new Date().toISOString().split('T')[0]
                });
                showToast('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸš€', 'success');
                e.target.reset();
                document.getElementById('departureCongestionIndicator').classList.remove('show');
                document.getElementById('departureLuggageGroup').style.display = 'none';
            } catch (err) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
            }
        });

        let selectedType = null;
        document.querySelectorAll('.request-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.request-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedType = btn.dataset.request;
                document.getElementById('requestDetails').classList.add('show');
            });
        });

        document.getElementById('submitRequest').addEventListener('click', async () => {
            const booking = document.getElementById('requestBookingNumber').value;
            const notes = document.getElementById('requestNotes').value;
            if (!booking || !selectedType) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨', 'warning'); return; }
            try {
                const types = {cleaning:'ğŸ§¹ Ø·Ù„Ø¨ ØªÙ†Ø¸ÙŠÙ',supplies:'ğŸ§´ Ø·Ù„Ø¨ Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª',maintenance:'ğŸ”§ Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø©',food:'ğŸ½ï¸ Ø·Ù„Ø¨ Ø·Ø¹Ø§Ù…',other:'ğŸ’¬ Ø·Ù„Ø¨ Ø¢Ø®Ø±'};
                await addDoc(collection(db, 'requests'), {
                    bookingNumber: booking, type: selectedType, typeDisplay: types[selectedType], notes,
                    status: 'new', statusDisplay: 'Ø¬Ø¯ÙŠØ¯', assignedTo: null, createdAt: Timestamp.now(),
                    assignedAt: null, completedAt: null, responseTime: null, completionTime: null
                });
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ğŸ›ï¸', 'success');
                document.getElementById('requestNotes').value = '';
                document.getElementById('requestDetails').classList.remove('show');
                document.querySelectorAll('.request-btn').forEach(b => b.classList.remove('active'));
            } catch (err) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            }
        });

        const faq = {
            'Ù…Ø§ Ù‡ÙŠ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¥ÙØ·Ø§Ø±': 'ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¥ÙØ·Ø§Ø± Ù…Ù† 7:00 ØµØ¨Ø§Ø­Ø§Ù‹ Ø­ØªÙ‰ 11:00 ØµØ¨Ø§Ø­Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø·Ø¹Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.',
            'Ø£ÙŠÙ† Ù…ÙˆÙ‚Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª': 'Ù…ÙˆÙ‚Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙŠÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø³ÙÙ„ÙŠ (B1). Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ù…ØªØ§Ø­Ø© Ù…Ø¬Ø§Ù†Ø§Ù‹.',
            'ÙƒÙŠÙ Ø£ØªØµÙ„ Ø¨Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„': 'Ø§Ø¶ØºØ· 0 Ù…Ù† Ù‡Ø§ØªÙ Ø§Ù„ØºØ±ÙØ©ØŒ Ø£Ùˆ Ø§ØªØµÙ„ Ø¹Ù„Ù‰: 0555-123-4567'
        };

        function handleChat(msg) {
            if (!msg.trim()) return;
            const msgs = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user-message';
            userMsg.textContent = msg;
            msgs.appendChild(userMsg);
            msgs.scrollTop = msgs.scrollHeight;
            setTimeout(() => {
                let answer = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©. ğŸ“';
                for (let q in faq) {
                    if (msg.includes(q) || q.includes(msg)) { answer = faq[q]; break; }
                }
                const botMsg = document.createElement('div');
                botMsg.className = 'chat-message bot-message';
                botMsg.textContent = answer;
                msgs.appendChild(botMsg);
                msgs.scrollTop = msgs.scrollHeight;
            }, 500);
        }

        document.getElementById('sendChatBtn').addEventListener('click', () => {
            handleChat(document.getElementById('chatInput').value);
            document.getElementById('chatInput').value = '';
        });

        document.getElementById('chatInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                handleChat(e.target.value);
                e.target.value = '';
            }
        });

        document.querySelectorAll('.quick-q-btn').forEach(btn => {
            btn.addEventListener('click', () => handleChat(btn.dataset.question));
        });
    </script>
</body>
</html>
