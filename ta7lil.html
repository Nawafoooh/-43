<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج تحليل الدرجات - متوسطة المنذر بن عمرو الأنصاري</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Arial,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#e8ecf1 100%);min-height:100vh;padding:20px;}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.1);overflow:hidden}
        .header{background:linear-gradient(135deg,#005c4b 0%,#007a63 100%);color:white;padding:30px;text-align:center}
        .logo-section text-align:center}
        h1{font-size:28px;margin-bottom:10px}
        .subtitle{font-size:16px;opacity:.9}
        .content{padding:40px}
        .form-section{background:#f8f9fa;padding:30px;border-radius:10px;margin-bottom:30px}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600;color:#333;font-size:15px}
        select,input[type="text"],input[type="date"]{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:15px;font-family:inherit;transition:border-color .3s}
        select:focus,input:focus{outline:none;border-color:#005c4b}
        .file-input-wrapper{position:relative;margin-top:20px}
        .file-input-label{display:block;padding:15px 30px;background:#005c4b;color:white;text-align:center;border-radius:8px;cursor:pointer;transition:background .3s;font-size:16px;font-weight:600}
        .file-input-label:hover{background:#007a63}
        input[type="file"]{display:none}
        .btn{padding:15px 40px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;font-family:inherit}
        .btn-primary{background:#005c4b;color:white}
        .btn-primary:hover{background:#007a63;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,92,75,.3)}
        .btn-secondary{background:#6c757d;color:white;margin-left:10px}
        .btn-secondary:hover{background:#5a6268}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0}
        .stat-card{background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%);padding:20px;border-radius:10px;border:2px solid #e9ecef;text-align:center}
        .stat-value{font-size:32px;font-weight:bold;color:#005c4b;margin:10px 0}
        .stat-label{font-size:14px;color:#6c757d}
        .table-container{overflow-x:auto;margin:30px 0;border-radius:10px;border:1px solid #dee2e6}
        table{width:100%;border-collapse:collapse;background:white}
        th,td{padding:12px;text-align:center;border-bottom:1px solid #dee2e6}
        th{background:#005c4b;color:white;font-weight:600}
        tr:hover{background:#f8f9fa}
        .hidden{display:none}
        .actions{text-align:center;margin-top:30px}
        .alert{padding:15px;border-radius:8px;margin-bottom:20px}
        .alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .alert-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
        #chartContainer{margin:30px 0;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .footer{text-align:center;padding:20px;color:#6c757d;font-size:14px;border-top:1px solid #dee2e6}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <h1>برنامج تحليل الدرجات</h1>
                <div class="subtitle">متوسطة المنذر بن عمرو الأنصاري | إدارة تعليم منطقة المدينة المنورة</div>
                <div class="subtitle">المدير: خالد المطيري | almuntherschool@gmail.com</div>
            </div>
        </div>

        <div class="content">
            <!-- Input Form -->
            <div id="inputSection" class="form-section">
                <div class="form-group">
                    <label for="grade">الصف:</label>
                    <select id="grade">
                        <option value="">اختر الصف</option>
                        <option value="أول متوسط">أول متوسط</option>
                        <option value="ثاني متوسط">ثاني متوسط</option>
                        <option value="ثالث متوسط">ثالث متوسط</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="section">الشعبة:</label>
                    <select id="section">
                        <option value="">اختر الشعبة</option>
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subject">مادة الاختبار:</label>
                    <input type="text" id="subject" placeholder="مثال: الرياضيات">
                </div>
                <div class="form-group">
                    <label for="examDate">تاريخ الاختبار:</label>
                    <input type="date" id="examDate">
                </div>
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-input-label">📁 استيراد ملف Excel أو CSV</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <div id="alertContainer"></div>
                <div class="stats-grid" id="statsGrid"></div>
                <div class="table-container">
                    <table id="dataTable">
                        <thead><tr><th>الاسم</th><th>الدرجة</th><th>التقدير</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div id="chartContainer"><canvas id="histogramChart"></canvas></div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="generatePDF()">📄 إنشاء تقرير PDF</button>
                    <button class="btn btn-secondary" onclick="resetApp()">🔄 بداية جديدة</button>
                </div>
            </div>
        </div>

        <div class="footer">Nawaf Alsubhi 2025</div>
    </div>

    <!-- المكتبات -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        let studentData=[],statistics={},chartInstance=null;

        document.getElementById('fileInput').addEventListener('change',handleFileUpload);
        document.getElementById('examDate').valueAsDate=new Date();

        function handleFileUpload(e){
            const file=e.target.files[0]; if(!file||!validateInputs())return;
            const reader=new FileReader();
            reader.onload=function(ev){
                try{
                    const data=new Uint8Array(ev.target.result);
                    const wb=XLSX.read(data,{type:'array'});
                    const ws=wb.Sheets[wb.SheetNames[0]];
                    const json=XLSX.utils.sheet_to_json(ws);
                    processData(json);
                }catch{showAlert('خطأ في قراءة الملف','error')}
            };
            reader.readAsArrayBuffer(file);
        }
        function validateInputs(){
            const g=document.getElementById('grade').value,
                  s=document.getElementById('section').value,
                  sub=document.getElementById('subject').value,
                  d=document.getElementById('examDate').value;
            if(!g||!s||!sub||!d){showAlert('يرجى ملء جميع الحقول','error');return false}
            return true;
        }
        function processData(data){
            studentData=[];
            const row=data[0];
            const scoreKey=Object.keys(row).find(k=>/score|degree|درجة/i.test(k));
            const nameKey=Object.keys(row).find(k=>/name|student|اسم|طالب/i.test(k));
            if(!scoreKey||!nameKey){showAlert('لم يتم العثور على أعمدة الاسم والدرجة','error');return}
            data.forEach(r=>{
                const name=r[nameKey],score=parseFloat(r[scoreKey]);
                if(name&&!isNaN(score))studentData.push({name,score});
            });
            if(studentData.length===0){showAlert('لا توجد بيانات صالحة','error');return}
            calculateStatistics();
            displayResults();
            showAlert(`تم استيراد ${studentData.length} طالب`,'success');
        }
        function calculateStatistics(){
            const sc=studentData.map(s=>s.score).sort((a,b)=>a-b),n=sc.length;
            const sum=sc.reduce((a,b)=>a+b,0),mean=sum/n,min=sc[0],max=sc[n-1],range=max-min;
            const median=n%2===0?(sc[n/2-1]+sc[n/2])/2:sc[Math.floor(n/2)];
            const freq={}; sc.forEach(v=>freq[v]=(freq[v]||0)+1);
            const maxF=Math.max(...Object.values(freq));
            const mode=Object.keys(freq).filter(k=>freq[k]===maxF).map(Number);
            const variance=sc.reduce((s,v)=>s+Math.pow(v-mean,2),0)/n;
            const stdDev=Math.sqrt(variance);
            const q1=sc[Math.floor(n*0.25)],q3=sc[Math.floor(n*0.75)],iqr=q3-q1;
            const outliers=sc.filter(v=>v<q1-1.5*iqr||v>q3+1.5*iqr).length;
            const passCount=sc.filter(v=>v>=60).length,failCount=n-passCount;
            const passRate=((passCount/n)*100).toFixed(2);
            const grades=[
                {name:'ممتاز',min:90,max:100,color:'#28a745'},
                {name:'جيد جداً',min:80,max:89.99,color:'#17a2b8'},
                {name:'جيد',min:70,max:79.99,color:'#ffc107'},
                {name:'مقبول',min:60,max:69.99,color:'#fd7e14'},
                {name:'ضعيف',min:0,max:59.99,color:'#dc3545'}
            ];
            const gradeDist=grades.map(g=>{
                const c=sc.filter(s=>s>=g.min&&s<=g.max).length;
                return{name:g.name,count:c,percentage:((c/n)*100).toFixed(2),color:g.color};
            });
            const binCount=Math.min(10,Math.ceil(Math.sqrt(n)));
            const binWidth=range/binCount;
            const bins=Array(binCount).fill(0);
            const binLabels=[];
            for(let i=0;i<binCount;i++){
                const a=min+i*binWidth,b=a+binWidth;
                binLabels.push(`${a.toFixed(0)}-${b.toFixed(0)}`);
                bins[i]=sc.filter(v=>v>=a&&v<b).length;
            }
            bins[binCount-1]+=sc.filter(v=>v===max).length;
            statistics={
                count:n,mean:mean.toFixed(2),median:median.toFixed(2),
                mode:mode.length?mode.join(', '):'لا يوجد',
                min:min.toFixed(2),max:max.toFixed(2),range:range.toFixed(2),
                stdDev:stdDev.toFixed(2),variance:variance.toFixed(2),
                q1:q1.toFixed(2),q3:q3.toFixed(2),iqr:iqr.toFixed(2),outliers,
                passCount,failCount,passRate,gradeDistribution:gradeDist,
                bins,binLabels
            };
        }
        function displayResults(){
            document.getElementById('resultsSection').classList.remove('hidden');
            const statsGrid=document.getElementById('statsGrid');
            statsGrid.innerHTML=`
                <div class="stat-card"><div class="stat-label">عدد الطلاب</div><div class="stat-value">${statistics.count}</div></div>
                <div class="stat-card"><div class="stat-label">المتوسط</div><div class="stat-value">${statistics.mean}</div></div>
                <div class="stat-card"><div class="stat-label">الوسيط</div><div class="stat-value">${statistics.median}</div></div>
                <div class="stat-card"><div class="stat-label">المنوال</div><div class="stat-value" style="font-size:20px">${statistics.mode}</div></div>
                <div class="stat-card"><div class="stat-label">الانحراف المعياري</div><div class="stat-value">${statistics.stdDev}</div></div>
                <div class="stat-card"><div class="stat-label">أعلى درجة</div><div class="stat-value">${statistics.max}</div></div>
                <div class="stat-card"><div class="stat-label">أقل درجة</div><div class="stat-value">${statistics.min}</div></div>
                <div class="stat-card"><div class="stat-label">نسبة النجاح</div><div class="stat-value">${statistics.passRate}%</div></div>`;
            const gradeTableHTML=`
                <div class="table-container" style="margin:30px 0">
                    <h3 style="text-align:center;color:#005c4b;margin-bottom:15px">توزيع التقديرات</h3>
                    <table style="background:white">
                        <thead><tr style="background:#005c4b"><th>التقدير</th><th>عدد الطلاب</th><th>النسبة</th></tr></thead>
                        <tbody>
                            ${statistics.gradeDistribution.map(g=>`
                                <tr><td style="font-weight:bold;color:${g.color}">${g.name}</td>
                                <td style="font-size:18px;font-weight:bold">${g.count}</td>
                                <td style="font-size:18px;font-weight:bold;color:${g.color}">%${g.percentage}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
            document.querySelector('.table-container').insertAdjacentHTML('beforebegin',gradeTableHTML);
            const tbody=document.getElementById('tableBody'); tbody.innerHTML='';
            studentData.forEach(st=>{
                let gr='',color='';
                if(st.score>=90){gr='ممتاز';color='#28a745';}
                else if(st.score>=80){gr='جيد جداً';color='#17a2b8';}
                else if(st.score>=70){gr='جيد';color='#ffc107';}
                else if(st.score>=60){gr='مقبول';color='#fd7e14';}
                else{gr='ضعيف';color='#dc3545';}
                tbody.innerHTML+=`<tr><td>${st.name}</td><td style="font-weight:bold;font-size:16px">${st.score.toFixed(2)}</td><td style="color:${color};font-weight:bold;font-size:15px">${gr}</td></tr>`;
            });
            displayHistogram();
            document.getElementById('resultsSection').scrollIntoView({behavior:'smooth'});
        }
        function displayHistogram(){
            const ctx=document.getElementById('histogramChart').getContext('2d');
            if(chartInstance)chartInstance.destroy();
            chartInstance=new Chart(ctx,{
                type:'bar',
                data:{
                    labels:statistics.binLabels,
                    datasets:[{label:'عدد الطلاب',data:statistics.bins,backgroundColor:'rgba(0,92,75,.7)',borderColor:'rgba(0,92,75,1)',borderWidth:2}]
                },
                options:{
                    responsive:true,
                    plugins:{legend:{display:true,labels:{font:{size:14,family:'Segoe UI'}}},title:{display:true,text:'توزيع الدرجات',font:{size:18,family:'Segoe UI'}}},
                    scales:{y:{beginAtZero:true,ticks:{stepSize:1,font:{size:12}}},x:{ticks:{font:{size:12}}}}
                }
            });
            const pieContainer=document.createElement('div');
            pieContainer.id='pieChartContainer';
            pieContainer.style.cssText='margin:30px auto;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.05);max-width:500px';
            pieContainer.innerHTML='<canvas id="gradeChart"></canvas>';
            document.getElementById('chartContainer').insertAdjacentElement('afterend',pieContainer);
            const pieCtx=document.getElementById('gradeChart').getContext('2d');
            new Chart(pieCtx,{
                type:'pie',
                data:{
                    labels:statistics.gradeDistribution.map(g=>g.name),
                    datasets:[{data:statistics.gradeDistribution.map(g=>g.count),backgroundColor:statistics.gradeDistribution.map(g=>g.color),borderWidth:2,borderColor:'#fff'}]
                },
                options:{
                    responsive:true,
                    plugins:{
                        legend:{position:'bottom',labels:{font:{size:13,family:'Segoe UI'},padding:15}},
                        title:{display:true,text:'توزيع التقديرات',font:{size:18,family:'Segoe UI'}},
                        tooltip:{callbacks:{label:function(ctx){const p=statistics.gradeDistribution[ctx.dataIndex].percentage;return`${ctx.label}: ${ctx.parsed} طالب (${p}%)`}}}
                    }
                }
            });
        }
        async function generatePDF(){
            const grade=document.getElementById('grade').value;
            const section=document.getElementById('section').value;
            const subject=document.getElementById('subject').value;
            const examDate=document.getElementById('examDate').value;

            showAlert('جاري إنشاء التقرير...','success');

            const element=document.getElementById('resultsSection');
            const canvas=await html2canvas(element,{scale:2,useCORS:true,logging:false});
            const imgData=canvas.toDataURL('image/png',1.0);

            const {jsPDF}=window.jspdf;
            const pdf=new jsPDF('p','mm','a4');
            const imgWidth=210;
            const pageHeight=297;
            const imgHeight=(canvas.height*imgWidth)/canvas.width;
            let heightLeft=imgHeight;
            let position=0;

            pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
            heightLeft-=pageHeight;

            while(heightLeft>=0){
                position=heightLeft-imgHeight;
                pdf.addPage();
                pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
                heightLeft-=pageHeight;
            }
            pdf.save(`تقرير_${subject}_${grade}_شعبة${section}_${examDate}.pdf`);
            showAlert('تم إنشاء التقرير بنجاح!','success');
        }
        function showAlert(msg,tp){
            const box=document.getElementById('alertContainer');
            const cls=tp==='success'?'alert-success':'alert-error';
            box.innerHTML=`<div class="alert ${cls}">${msg}</div>`;
            setTimeout(()=>box.innerHTML='',5000);
        }
        function resetApp(){
            if(!confirm('هل تريد البدء من جديد؟ سيتم حذف جميع البيانات الحالية.'))return;
            studentData=[];statistics={};generatedPDF=null;
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('fileInput').value='';
            if(chartInstance){chartInstance.destroy();chartInstance=null;}
            const pieContainer=document.getElementById('pieChartContainer');
            if(pieContainer)pieContainer.remove();
            showAlert('تم إعادة تعيين البرنامج بنجاح','success');
            window.scrollTo({top:0,behavior:'smooth'});
        }
    </script>
</body>
</html>
